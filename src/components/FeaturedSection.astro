---
const courses = [
  {
    title: "Free Math PSLE 10 Years Series",
    claimedText: ["10 parents have claimed it"],
    buttonText: "Get It Now",
    buttonColor: "bg-primary hover:bg-blue-800",
    image: "/items/education-of-ideas.svg",
    link: null,
  },
  {
    title: "Free 1 on 1 Session Trial",
    claimedText: ["Money Back Guarantee", "21 Slots Left"],
    buttonText: "Start Trial",
    buttonColor: "bg-primary hover:bg-blue-800",
    image: "/items/online-education.svg",
    link: null,
  },
  {
    title: "Free Past Year Math Exam Papers",
    claimedText: ["20 parents have seen it"],
    buttonText: "Get It Now",
    buttonColor: "bg-primary hover:bg-blue-800",
    image: "/items/value-of-knowledge.svg",
    link: "/free-exam-papers",
  },
  {
    title: "Free Exam Paper Analysis",
    claimedText: ["Actionable feedback included"],
    buttonText: "Get Analysis",
    buttonColor: "bg-primary hover:bg-blue-800",
    image: "/items/online-education-2.svg",
    link: "https://ez1.sg/analysis",
    newTab: true,
  },
];
---

<div id="free-1-on-1-session-trial" class="py-8 sm:py-16 bg-background">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-8 lg:gap-12">
      {
        courses.map((course) => (
          <div class="flex flex-col items-center text-center p-3 sm:p-0 h-full">
            {/* Title */}
            <h3 class="text-base sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-0 h-24 sm:h-28 flex items-center justify-center text-center">
              {course.title}
            </h3>
            {course.claimedText?.length ? (
              <div class="mt-2 mb-4 sm:mb-6 flex flex-wrap items-center justify-center gap-2 min-h-[1.5rem]">
                {course.claimedText.map((label) => {
                  const isSlotsLabel =
                    course.title === "Free 1 on 1 Session Trial" &&
                    label.toLowerCase().includes("slots left");
                  return (
                    <span
                      class="inline-flex items-center rounded-full border border-primary/50 px-3 py-1 text-[11px] sm:text-xs font-semibold uppercase tracking-wide text-primary"
                      data-slots-left={isSlotsLabel ? "true" : undefined}>
                      {label}
                    </span>
                  );
                })}
              </div>
            ) : (
              <div class="mt-2 mb-4 sm:mb-6 min-h-[1.5rem]" />
            )}

            {/* Image */}
            <div class="w-full max-w-[180px] sm:max-w-sm h-36 sm:h-44 lg:h-48 mb-0 sm:mb-4 lg:mb-8 rounded-lg overflow-hidden flex items-center justify-center bg-white">
              <img
                src={course.image}
                alt={course.title}
                class="w-full h-full object-contain"
              />
            </div>

            {/* Button */}
            {course.link ? (
              <a
                href={course.link}
                target={course.newTab ? "_blank" : undefined}
                rel={course.newTab ? "noreferrer" : undefined}
                class={`${course.buttonColor} text-white px-4 sm:px-8 py-3 sm:py-4 rounded-full text-sm sm:text-lg font-semibold transition-colors duration-200 w-full max-w-[180px] sm:max-w-xs text-center block mt-auto`}>
                {course.buttonText}
              </a>
            ) : (
              <button
                onclick={
                  course.title === "Free Math PSLE 10 Years Series"
                    ? "openPSLESeriesPopup()"
                    : course.title === "Free 1 on 1 Session Trial"
                      ? "openTuitionClassesPopup()"
                      : ""
                }
                class={`${course.buttonColor} text-white px-4 sm:px-8 py-3 sm:py-4 rounded-full text-sm sm:text-lg font-semibold transition-colors duration-200 w-full max-w-[180px] sm:max-w-xs mt-auto`}>
                {course.buttonText}
              </button>
            )}
          </div>
        ))
      }
    </div>
  </div>
</div>

<script type="module">
  const slotsEl = document.querySelector("[data-slots-left]");
  const parseSlotsCount = (text) => {
    if (!text) return null;
    const match = text.match(/(\d+)/);
    return match ? Number(match[1]) : null;
  };
  const setSlotsText = (count) => {
    if (!slotsEl) return;
    slotsEl.textContent = `${count} Slots Left`;
  };
  const animateSlotsCount = (from, to) => {
    if (!slotsEl) return;
    if (!Number.isFinite(from) || !Number.isFinite(to) || from === to) {
      setSlotsText(to);
      return;
    }

    const start = performance.now();
    const duration = 900;
    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

    const step = (now) => {
      const progress = Math.min((now - start) / duration, 1);
      const current = Math.round(from + (to - from) * easeOutCubic(progress));
      setSlotsText(current);

      if (progress < 1) {
        requestAnimationFrame(step);
      } else if (slotsEl.animate) {
        slotsEl.animate(
          [
            { transform: "scale(1)", boxShadow: "0 0 0 rgba(59,130,246,0)" },
            {
              transform: "scale(1.06)",
              boxShadow: "0 0 0 4px rgba(59,130,246,0.2)",
            },
            { transform: "scale(1)", boxShadow: "0 0 0 rgba(59,130,246,0)" },
          ],
          { duration: 450, easing: "ease-out" },
        );
      }
    };

    requestAnimationFrame(step);
  };
  let currentCount = slotsEl ? (parseSlotsCount(slotsEl.textContent) ?? 0) : 0;

  const updateSlotsLeft = async () => {
    if (!slotsEl) return;

    try {
      const response = await fetch("/api/schedule", { cache: "no-store" });
      if (!response.ok) return;
      const data = await response.json();
      const days = Array.isArray(data?.days) ? data.days : [];
      const count = days.reduce((total, day) => {
        const slots = Array.isArray(day?.slots) ? day.slots : [];
        return total + slots.length;
      }, 0);
      animateSlotsCount(currentCount, count);
      currentCount = count;
    } catch (error) {}
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", updateSlotsLeft);
  } else {
    updateSlotsLeft();
  }
</script>

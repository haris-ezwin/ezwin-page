---
import Layout from "@layouts/Layout.astro";
import Container from "@components/container.astro";

const SKELETON_CARDS = Array.from({ length: 6 }, (_, index) => index);
---

<Layout title="Schedule">
  <Container>
    <div class="py-16 md:py-24">
      <div class="mx-auto max-w-6xl">
        <h1
          class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 text-center">
          Class Schedule
        </h1>
        <p class="text-xl text-gray-600 mb-12 text-center">
          Choose a time slot that works best for your child for 2026
        </p>

        <div
          class="text-sm text-gray-500 text-center mb-6"
          data-schedule-loading
          role="status"
          aria-live="polite">
          Loading the latest schedule...
        </div>
        <div
          class="text-sm text-rose-500 text-center mb-6 hidden"
          data-schedule-error
          aria-live="polite"></div>

        <!-- Timetable Cards -->
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" data-schedule-grid>
          {
            SKELETON_CARDS.map((card) => (
              <div
                class="bg-white rounded-lg shadow-md p-6 border-t-4 border-gray-200 animate-pulse"
                aria-hidden="true"
                data-schedule-skeleton
                key={card}>
                <div class="h-6 w-32 bg-gray-200 rounded mb-4"></div>
                <div class="space-y-3">
                  <div class="h-4 bg-gray-200 rounded"></div>
                  <div class="h-4 bg-gray-200 rounded"></div>
                  <div class="h-4 bg-gray-200 rounded"></div>
                </div>
              </div>
            ))
          }
        </div>

        <script type="module">
          const DAY_ORDER = [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
            "Sunday",
          ];
          const loadingEl = document.querySelector("[data-schedule-loading]");
          const errorEl = document.querySelector("[data-schedule-error]");
          const gridEl = document.querySelector("[data-schedule-grid]");

          const normalizeDay = (day) => {
            if (!day) return "Unscheduled";
            const trimmed = day.trim();
            return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
          };

          const orderIndex = (day) => {
            const index = DAY_ORDER.indexOf(day);
            return index === -1 ? Number.MAX_SAFE_INTEGER : index;
          };

          const normalizeSchedule = (days) => {
            const normalized = (Array.isArray(days) ? days : []).map((day) => {
              const title = normalizeDay(
                typeof day?.title === "string" ? day.title : "Unscheduled",
              );
              const slots = Array.isArray(day?.slots) ? day.slots : [];
              const cleanSlots = slots
                .map((slot) => ({
                  time: typeof slot?.time === "string" ? slot.time : "",
                }))
                .filter((slot) => slot.time);
              return { title, slots: cleanSlots };
            });

            const existingTitles = new Set(
              normalized.map((day) => day.title),
            );
            ["Monday", "Tuesday", "Wednesday"].forEach((day) => {
              if (!existingTitles.has(day)) {
                normalized.push({ title: day, slots: [] });
              }
            });

            normalized.sort((a, b) => orderIndex(a.title) - orderIndex(b.title));
            return normalized;
          };

          const buildDayCard = (day) => {
            const card = document.createElement("div");
            card.className = `bg-white rounded-lg shadow-md p-6 border-t-4 ${
              day.slots?.length ? "border-primary" : "border-gray-300"
            }`;

            const title = document.createElement("h3");
            title.className = "text-2xl font-bold text-gray-900 mb-4";
            title.textContent = day.title;
            card.appendChild(title);

            if (!day.slots?.length) {
              const emptyWrap = document.createElement("div");
              emptyWrap.className = "text-gray-500 italic space-y-2";
              const emptyText = document.createElement("p");
              emptyText.textContent = "No available slots.";
              emptyWrap.appendChild(emptyText);
              card.appendChild(emptyWrap);
              return card;
            }

            const slotsWrap = document.createElement("div");
            slotsWrap.className = "space-y-4";
            day.slots.forEach((slot) => {
              const slotCard = document.createElement("div");
              slotCard.className =
                "bg-blue-50 px-4 py-3 rounded-lg border-l-4 border-primary";
              const timeEl = document.createElement("p");
              timeEl.className = "text-primary font-semibold";
              timeEl.textContent = slot.time;
              slotCard.appendChild(timeEl);
              slotsWrap.appendChild(slotCard);
            });
            card.appendChild(slotsWrap);
            return card;
          };

          const renderSchedule = (days) => {
            if (!gridEl) return;
            gridEl.innerHTML = "";
            days.forEach((day) => {
              gridEl.appendChild(buildDayCard(day));
            });
          };

          const loadSchedule = async () => {
            if (!gridEl) return;
            if (loadingEl) loadingEl.classList.remove("hidden");
            if (errorEl) errorEl.classList.add("hidden");

            try {
              const response = await fetch("/api/schedule", {
                cache: "no-store",
              });
              if (!response.ok) {
                throw new Error("Schedule fetch failed");
              }
              const data = await response.json();
              const normalized = normalizeSchedule(data?.days);
              renderSchedule(normalized);
            } catch (error) {
              if (errorEl) {
                errorEl.textContent =
                  "Unable to load the latest schedule right now.";
                errorEl.classList.remove("hidden");
              }
              if (gridEl) {
                gridEl.innerHTML = "";
              }
            } finally {
              if (loadingEl) loadingEl.classList.add("hidden");
            }
          };

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", loadSchedule);
          } else {
            loadSchedule();
          }
        </script>

        <!-- CTA -->
        <div class="mt-12 text-center">
          <p class="text-lg text-gray-600 mb-6">
            Ready to join a class? Start your 1 month trial.
          </p>
          <button
            type="button"
            onclick="openTuitionClassesPopup()"
            class="bg-primary hover:bg-blue-800 text-white px-8 py-4 rounded-full text-lg font-semibold transition-colors duration-200 inline-block">
            1 Month Trial
          </button>
        </div>
      </div>
    </div>
  </Container>
</Layout>

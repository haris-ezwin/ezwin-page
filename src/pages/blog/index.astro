---
import Container from "@components/container.astro";
import Layout from "@layouts/Layout.astro";
import { getFormattedDate } from "@utils/all";
import { getAllBlogPosts } from "@utils/prismic";

type BlogPostCard = {
  slug: string;
  title: string;
  snippet: string;
  publishDate: Date | null;
  image: { src: string; alt: string } | null;
};

const toPlainText = (field: unknown): string => {
  if (!field) return "";
  if (typeof field === "string") return field;
  if (Array.isArray(field)) {
    return field
      .map((block) => {
        if (
          typeof block === "object" &&
          block !== null &&
          "text" in block &&
          typeof (block as { text?: string }).text === "string"
        ) {
          return (block as { text?: string }).text ?? "";
        }
        return "";
      })
      .join(" ")
      .trim();
  }
  if (typeof field === "object" && field !== null) {
    const candidate = field as { text?: string };
    if (typeof candidate.text === "string") {
      return candidate.text;
    }
  }
  return "";
};

const pickImageField = (data: Record<string, any>) => {
  const imageKeys = ["featured_image", "cover_image", "image", "hero_image"];

  for (const key of imageKeys) {
    const value = data?.[key];
    if (value?.url) {
      return {
        src: value.url as string,
        alt: typeof value.alt === "string" ? value.alt : "",
      };
    }
  }

  return null;
};

const prismicPosts = await getAllBlogPosts();

// Normalize Prismic documents into the shape needed by the UI.
const posts: BlogPostCard[] = prismicPosts
  .map((post) => {
    const publishDateValue =
      post.data?.publishDate ??
      post.data?.publish_date ??
      post.first_publication_date ??
      post.last_publication_date ??
      null;

    return {
      slug: post.uid ?? post.slugs?.[0] ?? post.id,
      title: toPlainText(post.data?.title) || "Untitled post",
      snippet:
        toPlainText(post.data?.snippet) ||
        toPlainText(post.data?.excerpt) ||
        toPlainText(post.data?.description) ||
        (typeof post.data?.meta_description === "string"
          ? post.data.meta_description
          : ""),
      publishDate: publishDateValue ? new Date(publishDateValue) : null,
      image: pickImageField(post.data ?? {}),
    };
  })
  .filter((post) => Boolean(post.slug));

// Sort posts by publish date (newest first)
const sortedPosts = posts.sort(
  (a, b) => (b.publishDate?.valueOf() ?? 0) - (a.publishDate?.valueOf() ?? 0),
);
---

<Layout title="Blog | EzWin Academy">
  <Container>
    <div class="py-16 sm:py-20">
      <div class="text-center mb-12">
        <h1 class="text-4xl lg:text-5xl font-bold">Latest Blog Posts</h1>
        <p class="mt-4 text-lg text-gray-600">
          Tips, strategies, and insights for students and parents
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {
          sortedPosts.map((post) => (
            <article class="bg-white rounded-2xl border border-gray-300 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
              {post.image && (
                <div class="aspect-video">
                  <img
                    src={post.image.src}
                    alt={post.image.alt}
                    class="w-full h-full object-cover"
                  />
                </div>
              )}
              <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-900 line-clamp-2">
                  <a href={`/blog/${post.slug}`} class="hover:text-primary">
                    {post.title}
                  </a>
                </h2>
                <p class="mt-3 text-gray-600 line-clamp-3">
                  {post.snippet || "No preview available"}
                </p>
                <div class="mt-4 flex items-center justify-between">
                  <span class="text-sm text-gray-500">
                    {post.publishDate ? getFormattedDate(post.publishDate) : ""}
                  </span>
                  <a
                    href={`/blog/${post.slug}`}
                    class="text-primary font-medium hover:text-primary/80 inline-flex items-center gap-2">
                    Read More
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  </a>
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </div>
  </Container>
</Layout>
